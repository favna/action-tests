name: Release Crosspost

on:
  release:
    types:
      - published

jobs:
  Crosspost:
    name: Release Crosspost
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Parse release name
        id: get_release_name
        run: echo ::set-output name=release_name::$( [ -z "${{ github.event.release.name }}" ] && echo "${{ github.event.release.tag_name }}" || echo "${{ github.event.release.name }}" )
      - name: Send Release Message
        run: |
          BODY=$(echo "${{ secrets.RELEASE_WEBHOOK }}" | sed -r \
                -e ':a' \
                -e 'N' \
                -e '$!ba' \
                -e 's/\n/\t\t/g' \
                -e 's/\r//g' \
                -e 's/\t\t\t\t/\t\t/g' \
                -e 's/- +//g' \
                -e 's/### ([^\t]+)\t\t/"}, {"name": "\1", "value": "/g' \
                -e 's/^"}, //' \
                -e 's/$/"}/g' \
                -e 's/\t\t/\\n/g')

          PAYLOAD="{\"username\": \"GitHub Release\", \"embeds\": [{\"title\": \"${{ steps.get_release_name.outputs.release_name }}\", \"fields\": [$BODY]}]}"

          echo "$PAYLOAD"

          echo ::set-output name=response::$(curl -X POST \
                -H "Content-Type: application/json" \
                -d "$PAYLOAD" \
                "${{ secrets.RELEASE_WEBHOOK }}")